---
title: "Removing footnotes and appendix"
author: "Sarah Torrence"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, error = F)

# Box access
library(boxr)
box_auth()

# data manip
library(tidyverse)
library(tidytext)
#library(conText)

# data
# data/processed amicus files/shortened-amicus-brief-text.csv
amicus <- box_read("880862059511")
# data/processed amicus files/amicus summary.xlsx
alternate_rmv <- box_read("864995408351", sheet = "data") %>% 
  select(case, brief, id, alternative) %>% 
  filter(!is.na(alternative))
```

# Purpose

To pare down amicus text by removing unnecessary/irrelevant text.

1) Remove text BEFORE "Summary of Argument" keyword.

2) Remove text AFTER "Appendix" keyword

# Remove after "Summary of Argument"

For most documents, there exists the header "summary of argument." If it did not exist, it was manually entered into the document. This represents the point at which the brief starts discussing their argument. We don't need text prior to this, as it's mainly intro information about the case and/or the authors. If "summary of argument" text doesn't exist (only in the case of a few pdfs), use the `alternative_rmv` df to find where to start reading the text.

alternate removal strings

```{r}
alternate_rmv %>% select(id,alternative)
```

Remove text before summary of argument (already done)

```{r}
# remove text after "summary of argument" if it exists
amicus <- amicus %>% 
  mutate(txt_full = str_to_lower(txt_full),
         txt_full = str_squish(txt_full),
         txt_short = case_when(
           grepl("summary of argument", txt_full) ~ 
             gsub(pattern = ".*summary of argument", replacement = "", x = txt_full),
           grepl("summary of the argument", txt_full) ~
             gsub(pattern = ".*summary of the argument", replacement = "", x = txt_full),
           id == 861820908073 ~ gsub(pattern = ".*introduction and summary", replacement = "", 
                                     x = txt_full),
           id == 861820896073 ~ gsub(pattern = ".*introduction", replacement = "", x = txt_full),
           id == 861822667487 ~ gsub(pattern = ".*introduction", replacement = "", x = txt_full),
           T ~ ""),
         txt_short = str_squish(txt_short))
```

Check none are missed 

```{r}
amicus %>% filter(txt_short == "") %>% select(-txt_full)
```

Check a few by running this line a few times.

```{r}
#amicus %>% sample_n(1) %>% pull(txt_short)
```


# Check instances of "Appendix" or "Footnotes"


Use footnotes when present. If not footnotes, use appendix. If neither: check. There are 154 docs with neither




# Remove appendices instances

From undergrad assistant: "I have found that often, the appendix will start with an asterisk (usually *1A Appendix). The Appendix also almost always immediately precedes the footnotes."

We need to:

1. find instances of "*1A Appendix" in the text 
2. Check that this only occurs 1x in a doc. 
3a. If 2) is true, then remove text after these instances.
3b. If 2) is false, further inspect the text (may require manual removal)
4. If it does not occur at all, check for the marker for footnotes (see next section). 
5a. If footnote marker exists, remove all text after
5b. If footnote marker does not exist, then manually inspect text. If there are footnotes/appendix, insert flag into text: "MNOPQRST" (w/o quotes) and remove all text after that flag. 

## 1. find instances of "*1A Appendix" in the text

```{r}
a <- amicus %>%
  mutate(txt_short = str_squish(txt_short),
    appendix = str_count(txt_short, "appendix"),
    appendix_1a = str_count(txt_short, "\\*1a appendix"),
    footnotes = str_count(txt_short, "footnotes"))
```

## 2. Check that this only occurs 1x in a doc. 

```{r}
table(a$appendix)
```

```{r}
table(a$appendix_1a)
```

There are only 55 documents that mention 1a appendix, but 295 that mention an appendix.This means if we remove text after `1a appendix` this covers 55 documents leaving 240 documents mentioning `appendix` left to deal with.

## 3a. If 2) is true, then remove text after these instances.s

This is preliminary code to remove text after `*1a appendix`.

```{r}
amicus_clean <- amicus %>% mutate(
         txt_short = str_squish(txt_short),
         txt_short = case_when(
           grepl("\\*1a appendix", txt_short) ~ 
             gsub(pattern = "\\*1a appendix.*", replacement = "", x = txt_short),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```

```{r}
amicus_clean %>% filter(txt_short == "")
```

## 3b. If 2) is false, further inspect the text (may require manual removal)

There were no documents that mentioned *1a appendix more than once so we can be confident that they were referring to the actual appendix. However, now there are 267 documents that contain `appendix` to deal with. Some of these include the documents above that already had the appendix remove so the real number of documents we need to remove is less if we just handle dealing with them in the same code chunk like lines 128-136.


```{r}
a_clean <- amicus_clean %>%
  mutate(txt_short = str_squish(txt_short),
    appendix = str_count(txt_short, "appendix"))

table(a_clean$appendix)
```

## 4. If it does not occur at all, check for the marker for footnotes (see next section). 

When all text after the appendix is removed, this will include any footnotes as the appendix precedes the footnotes. We now only need to remove the footnotes from additional documents that did not have an appendix.

```{r}
a_f <- a %>% filter(appendix_1a == 0 & appendix == 0)

table(a_f$footnotes)
```

There are 263 documents containing `footnotes` that don't mention `appendix`. 

I could not get your `get_context` code to work but I know from my previous research and some manual inspection that the following logic should work for removing footnotes. The footnotes are not referenced for the the footnotes section except to mention that something was omitted from the footnotes therefore removing or ignoring those instances, we can remove text after the first instance of the word `footnotes`.

1. ignore/remove these instances:
    * `footnotes omitted` or
    * 3 words from omitted
2. Use first finding of the word `footnotes` and remove text after that

We can also use some of your logic instead. The code below is pretty much what we need, but need to combined with logic above to only perform this on documents that didn't have appendix.

```{r}
#remove text with omitted within 3 words of footnotes
amicus_clean <- amicus_clean %>% mutate(
         txt_short = case_when(
           grepl('(footnotes (\\w+\\s){0,3}omitted)|(omitted (\\w+\\s){0,3}footnotes)', txt_short) ~ 
             gsub(pattern = '(footnotes (\\w+\\s){0,3}omitted)|(omitted (\\w+\\s){0,3}footnotes)',
                  replacement = "", x = txt_short),
           T ~ txt_short)
          )

#remove text after footnotes
amicus_clean <- amicus_clean %>% mutate(
         txt_short = str_squish(txt_short),
         txt_short = case_when(
           grepl("footnotes", txt_short) ~ 
             gsub(pattern = "footnotes.*", replacement = "", x = txt_short),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```


## more exploration

I wanted to look back at the full text before capitalization was removed becuase I noticed that many times an appendix might be referenced in text but when it is full caps like `APPENDIX` it references the actual appendix.

```{r}
amicus_full <- box_read("863216279471")
```

```{r}
amicus_ends_full <- amicus_full %>%
  mutate(txt_full = str_squish(txt_full),
    appendix = str_count(txt_full, "APPENDIX"),
         appendix_1a = str_count(txt_full, "\\*1A APPENDIX"))

a <- amicus_ends_full %>% select(case, brief, id, appendix, appendix_1a)

table(a$appendix)
```

```{r}
table(a$appendix_1a)
```

Only 53 instances contain `*1A APPENDIX` while 202 contain the word `APPENDIX`.

There were 55 that contained `*1a appendix` without caps so I think it would be good to ignore cases in this instance but `appendix` is mentioned in 295 docs so filtering down to the 202 with `APPENDIX` and handling the 93 remaining might be useful. I also didn't check for `Appendix` vs `appendix` but cases might help us narrow down here.

```{r}
amicus_lower <- amicus_full %>% mutate(txt_full = str_to_lower(txt_full))

amicus_lower_ends <- amicus_lower %>%
  mutate(txt_full = str_squish(txt_full),
    appendix = str_count(txt_full, "appendix"),
         appendix_1a = str_count(txt_full, "\\*1a appendix"))

a_lower <- amicus_lower_ends %>% select(case, brief, id, appendix, appendix_1a)

table(a_lower$appendix)
```

```{r}
table(a_lower$appendix_1a)
```
