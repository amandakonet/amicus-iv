---
title: "Removing footnotes and appendices"
author: "Sarah Torrence"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, error = F)

# Box access
library(boxr)
box_auth()

# data manip
library(tidyverse)
library(tidytext)

# data
# data/processed amicus files/raw-amicus-brief-text.csv
amicus <- box_read("863216279471")
# data/processed amicus files/amicus summary.xlsx
alternate_rmv <- box_read("864995408351", sheet = "data") %>% 
  select(case, brief, id, alternative) %>% 
  filter(!is.na(alternative))
#data/processed amicus files/footnotes-confirmed.csv
footnotes_ids <- box_read("908607927934")
```

# Purpose

To pare down amicus text by removing unnecessary/irrelevant text.

1) Remove text BEFORE "Summary of Argument" keyword.

2) Remove text AFTER "Appendix" keyword

# Remove before "Summary of Argument"

For most documents, there exists the header "summary of argument." If it did not exist, it was manually entered into the document. This represents the point at which the brief starts discussing their argument. We don't need text prior to this, as it's mainly intro information about the case and/or the authors. If "summary of argument" text doesn't exist (only in the case of a few pdfs), use the `alternative_rmv` df to find where to start reading the text.

alternate removal strings

```{r}
#alternate_rmv %>% select(id,alternative)
```

Remove text before summary of argument (already done in shortened-amicus-text csv, not raw text csv.)

```{r}
# remove text after "summary of argument" if it exists
amicus <- amicus %>%
  mutate(txt_full = str_squish(txt_full),
         txt_short = case_when(
           id == 861820795454 ~ gsub(pattern = ".*summary \\[\\*9\\] of the argument", replacement = "",
                                     x = txt_full, ignore.case = TRUE),
           grepl("summary of argument|Summary of Argument|SUMMARY OF ARGUMENT", txt_full,
                 ignore.case = TRUE) ~
             gsub(pattern = ".*summary of argument|.*Summary of Argument|.*SUMMARY OF ARGUMENT",
                  replacement = "",
                  x = txt_full, ignore.case = TRUE),
           grepl("summary of the argument", txt_full, ignore.case = TRUE) ~
             gsub(pattern = ".*summary of the argument", replacement = "",
                  x = txt_full, ignore.case = TRUE),
           id == 861820908073 ~ gsub(pattern = ".*introduction and summary", replacement = "",
                                     x = txt_full, ignore.case = TRUE),
           id == 861820896073 ~ gsub(pattern = ".*introduction", replacement = "",
                                     x = txt_full, ignore.case = TRUE),
           id == 861822667487 ~ gsub(pattern = ".*introduction", replacement = "",
                                     x = txt_full, ignore.case = TRUE),
           #this line can be changed to T ~ '' once the raw brief file is updated
           T ~ txt_full),
         txt_short = str_squish(txt_short))
```

Check none are missed

```{r}
amicus %>% filter(txt_short == "") %>% select(-txt_full)
```

Check a few by running this line a few times.

```{r}
#amicus %>% sample_n(1) %>% pull(txt_short)
```

# Removing Appendices

## Remove *1A Appendix

Whenever `*1A Appendix` shows up in the text, this is referring to the start of the appendix. We want to remove all text after this phrase from the briefs that contain this phrase.

### find instances of "*1A Appendix" in the text

```{r}
amicus <- amicus %>%
  mutate(txt_short = str_squish(txt_short),
    appendix_1a = str_count(txt_short, "\\*1a Appendix|\\*1A APPENDIX|\\*1A Appendix|\\*IA APPENDIX"))
```

Check that this only occurs 1x in a doc. 

```{r}
table(amicus$appendix_1a)
```


Since this phrase only occurs once in the briefs in which it is present, we can just remove all text after this text for those 56 briefs.

```{r}
amicus <- amicus %>% mutate(
         txt_short = str_squish(txt_short),
         txt_short = case_when(
           grepl("\\*1a appendix|\\*ia appendix", txt_short, ignore.case = TRUE) ~ 
             gsub(pattern = "\\*1a appendix.*|\\*ia appendix.*", replacement = "", x = txt_short,
                  ignore.case = TRUE),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```

Checking to make sure `*1A Appendix` references have been removed.

```{r}
a <- amicus %>%
  mutate(appendix_1a = str_count(txt_short, "\\*1a Appendix|\\*1A APPENDIX|\\*1A Appendix"))

table(a$appendix_1a)
```

## Handling APPENDIX A cases

From some manual inspection, it looks like when `APPENDIX A` is mentioned in all caps that is it referring to the first section of the appendix.

Let's see how many documents have `APPENDIX A` in them.

```{r}
amicus <- amicus %>% filter(appendix_1a == 0) %>%
  mutate(appendix_a = str_count(txt_short, "APPENDIX A"))

table(amicus$appendix_a)
```

`APPENDIX A` occurs in 56 briefs that did not already have the appendix removed. 

We want to manually look at some of the briefs that mention `APPENDIX A` to make sure it really is at the beginning of the appendix.

```{r}
amicus %>% filter(appendix_a > 0) %>% select(id, appendix_a)
```

After checking 10 briefs that mention `APPENDIX A` once and the 1 brief that mentions it twice, all first instances refer to the beginning of the appendix. Therefore, we can remove all text after `APPENDIX A`.

```{r}
amicus <- amicus %>% mutate(
         txt_short = case_when(
           appendix_1a == 0 &
           grepl("APPENDIX A", txt_short) ~ 
             gsub(pattern = "APPENDIX A.*", replacement = "", x = txt_short),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```

Checking to make sure `APPENDIX A` references have been removed.

```{r}
a <- amicus %>% filter(appendix_1a == 0) %>%
  mutate(appendix_a = str_count(txt_short, "APPENDIX A"))

table(a$appendix_a)
```

## Handling other forms of appendix

```{r}
amicus <- amicus %>% filter(appendix_1a == 0 & appendix_a == 0) %>% 
  mutate(appendix = str_count(txt_short, "APPENDIX"))

table(amicus$appendix)
```

There are still 86 briefs that mention `APPENDIX`. We want to manually look at some of the briefs that mention `APPENDIX` to see if they refer to the beginning of the appendix

```{r}
amicus %>% filter(appendix > 1) %>% select(id, appendix)
```

I manually checked all briefs with more than one reference of `APPENDIX` and the first instance of each is referring to the beginning of the appendix and I also randomly checked many briefs with only 1 reference so we can remove all text after this.

```{r}
amicus <- amicus %>% mutate(
         txt_short = case_when(
           appendix_1a == 0 & appendix_a == 0 &
           grepl("APPENDIX", txt_short) ~ 
             gsub(pattern = "APPENDIX.*", replacement = "", x = txt_short),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```

Checking to make sure `APPENDIX` references have been removed.

```{r}
a <- amicus %>% filter(appendix_1a == 0 & appendix_a == 0) %>%
  mutate(appendix = str_count(txt_short, "APPENDIX"))

table(a$appendix)
```


```{r}
a <- amicus %>% filter(appendix_1a == 0 & appendix_a == 0 & appendix == 0) %>%
  mutate(Appendix = str_count(txt_short, "Appendix"),
         appendix_all = str_count(txt_short, "appendix"))

table(a$Appendix)
```

There are 83 briefs remaining that mention `Appendix`.

```{r}
table(a$appendix_all)
```

There are 18 briefs remaining that mention `appendix`.

In taking a further look at some of these briefs, there is not really a good pattern to remove the rest of the appendices at scale.



# Removing Footnotes

First we want to convert all the text to lower case.

```{r}
amicus <- amicus %>% mutate(txt_short = str_to_lower(txt_short))
```

Now we want to check the mentions of `footnotes` in the briefs.

```{r}
amicus <- amicus %>%
  mutate(footnotes = str_count(txt_short, "footnotes"))

table(amicus$footnotes)
```

There are 345 briefs that mention footnotes.

After manual inspection, we noticed many instances of footnotes that refer to the actual footnotes section are `footnotes counsel of record` and `footnotes 1`. We want to check their mentions in the briefs.

```{r}
amicus <- amicus %>%
  mutate(footnotes_cor = str_count(txt_short, "footnotes counsel of record"),
         footnotes_1 = str_count(txt_short, "footnotes 1"))

table(amicus$footnotes_cor)
```


```{r}
table(amicus$footnotes_1)
```

We want to remove instance of `footnotes counsel of record` or `footnotes 1` that are in the list of footnotes ids.

```{r}
amicus <- amicus %>% mutate(
         txt_short = case_when(
           grepl("footnotes counsel of record", txt_short)
           & (id %in% footnotes_ids$id) ~ 
             gsub(pattern = "footnotes counsel of record.*", replacement = "", x = txt_short),
           grepl("footnotes 1", txt_short)
           & (id %in% footnotes_ids$id | id == '861814132010') ~ 
             gsub(pattern = "footnotes 1.*", replacement = "", x = txt_short),
           T ~ txt_short),
         txt_short = str_squish(txt_short))
```

Checking to make sure `footnotes counsel of record` and `footnotes 1` references have been removed.

```{r}
a <- amicus %>%
  mutate(footnotes_cor = str_count(txt_short, "footnotes counsel of record"),
         footnotes_1 = str_count(txt_short, "footnotes 1"))

table(a$footnotes_1)
```

```{r}
table(a$footnotes_cor)
```

Now let's see how many remaining briefs mention footnotes.

```{r}
a <- amicus %>% filter(footnotes_cor == 0 & footnotes_1 == 0) %>% 
  mutate(footnotes = str_count(txt_short, "footnotes"))

table(a$footnotes)
```

There are 149 briefs remaining that mention `footnotes`.

